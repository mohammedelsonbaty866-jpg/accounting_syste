<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>POS Ø¨Ù‚Ø§Ù„Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e3a8a">

<style>
body{margin:0;font-family:Tahoma;direction:rtl;background:#f1f5f9}
header{background:#1e3a8a;color:#fff;padding:14px;text-align:center;font-size:20px}
.tabs{display:flex}
.tabs button{flex:1;padding:12px;border:none;font-weight:bold}
.tabs .active{background:#1e3a8a;color:#fff}
.container{padding:10px}
.card{background:#fff;border-radius:12px;padding:10px;margin-bottom:10px;box-shadow:0 2px 6px #0001}
input,select,button{width:100%;padding:12px;margin:5px 0;font-size:16px}
button{border:none;border-radius:10px}
.btn{background:#1e3a8a;color:#fff}
.btn-green{background:#16a34a;color:#fff}
.btn-red{background:#dc2626;color:#fff}
.row{display:flex;gap:5px}
.row>*{flex:1}
.invoice{border:1px dashed #000;font-family:Courier New;padding:8px}
.item{display:flex;justify-content:space-between;border-bottom:1px dashed #000}
.total{font-size:20px;font-weight:bold;text-align:center;margin-top:8px}
.alert{color:red;text-align:center;font-weight:bold}
table{width:100%;border-collapse:collapse}
td,th{border:1px solid #ccc;padding:5px;text-align:center}
@media print{
body *{visibility:hidden}
#printArea,*#printArea *{visibility:visible}
#printArea{position:absolute;top:0;right:0;width:58mm}
}
</style>
</head>

<body>

<header>ğŸ›’ Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø¬ Ù…Ø­Ù…ÙˆØ¯</header>

<div class="tabs">
<button class="active" onclick="showTab('cashier',this)">ÙƒØ§Ø´ÙŠØ±</button>
<button onclick="showTab('products',this)">Ø£ØµÙ†Ø§Ù</button>
<button onclick="showTab('customers',this)">Ø¹Ù…Ù„Ø§Ø¡</button>
<button onclick="showTab('reports',this)">ØªÙ‚Ø§Ø±ÙŠØ±</button>
<button onclick="showTab('profits',this)">ğŸ’° Ø£Ø±Ø¨Ø§Ø­</button>
</div>

<!-- ÙƒØ§Ø´ÙŠØ± -->
<div id="cashier" class="container">
<div class="card">
<input id="search" placeholder="Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯" oninput="searchBarcode()">
<div class="row">
<input id="qty" type="number" value="1" min="1">
<button class="btn" onclick="scan()">ğŸ“· Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
</div>
<select id="productSelect"></select>
<button class="btn-green" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button>
<div id="stockAlert" class="alert"></div>
</div>

<div class="card invoice">
<div class="row">
<button class="btn-green" onclick="setPay('cash')">Ù†Ù‚Ø¯ÙŠ</button>
<button class="btn" onclick="setPay('credit')">Ø¢Ø¬Ù„</button>
</div>
<select id="customerSelect" style="display:none"></select>
<div id="items"></div>
<div class="total" id="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</div>
<button class="btn" onclick="saveInvoice()">Ø­ÙØ¸ + Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<video id="camera" style="display:none;width:100%"></video>
</div>

<!-- Ø£ØµÙ†Ø§Ù -->
<div id="products" class="container" style="display:none">
<div class="card">
<input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
<input id="pBuy" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
<input id="pPrice" type="number" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
<input id="pQty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
<input id="pCode" placeholder="Ø¨Ø§Ø±ÙƒÙˆØ¯">
<button class="btn" onclick="addProduct()">Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
</div>
<div class="card">
<table>
<thead><tr><th>Ø§Ø³Ù…</th><th>Ø´Ø±Ø§Ø¡</th><th>Ø¨ÙŠØ¹</th><th>ÙƒÙ…ÙŠØ©</th></tr></thead>
<tbody id="productTable"></tbody>
</table>
</div>
</div>

<!-- Ø¹Ù…Ù„Ø§Ø¡ -->
<div id="customers" class="container" style="display:none">
<div class="card">
<input id="cName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
<button class="btn" onclick="addCustomer()">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„</button>
</div>
<div class="card">
<table>
<thead><tr><th>Ø§Ø³Ù…</th><th>Ø±ØµÙŠØ¯</th><th>Ø³Ø¯Ø§Ø¯</th><th>Ù‚ÙÙ„</th></tr></thead>
<tbody id="customerTable"></tbody>
</table>
</div>
</div>

<!-- ØªÙ‚Ø§Ø±ÙŠØ± -->
<div id="reports" class="container" style="display:none">
<div class="card">
<button class="btn" onclick="reportDaily()">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
<button class="btn" onclick="reportMonthly()">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</button>
<button class="btn" onclick="reportYearly()">ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ</button>
<div id="report"></div>
</div>
</div>

<!-- Ø£Ø±Ø¨Ø§Ø­ + Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ -->
<div id="profits" class="container" style="display:none">
<div class="card">
<button class="btn" onclick="profitDaily()">Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</button>
<button class="btn" onclick="profitMonthly()">Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±</button>
<button class="btn" onclick="profitYearly()">Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†Ø©</button>
<div id="profitResult" class="total"></div>
</div>
<div class="card">
<button class="btn-green" onclick="backup()">ğŸ“¤ ØªØµØ¯ÙŠØ± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
<input type="file" onchange="restore(this)">
</div>
</div>

<div id="printArea"></div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
/* ===== Ø¨ÙŠØ§Ù†Ø§Øª ===== */
let products=JSON.parse(localStorage.products||"[]");
let customers=JSON.parse(localStorage.customers||"[]");
let invoices=JSON.parse(localStorage.invoices||"[]");
let cart=[];
let payType="cash";
let invoiceNo=+localStorage.invoiceNo||1;

/* ===== ÙˆØ§Ø¬Ù‡Ø© ===== */
function showTab(id,btn){
document.querySelectorAll(".container").forEach(d=>d.style.display="none");
document.getElementById(id).style.display="block";
document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
btn.classList.add("active");
renderAll();
}

/* ===== ÙƒØ§Ø´ÙŠØ± ===== */
function renderProducts(){
productSelect.innerHTML="";
products.forEach((p,i)=>{
productSelect.innerHTML+=`<option value="${i}">${p.n} (${p.s})</option>`;
});
stockAlert.innerHTML=products.filter(p=>p.s<=5).map(p=>"âš  Ù†ÙØ§Ø¯ "+p.n).join("<br>");
}

function searchBarcode(){
let v=search.value.trim();
let p=products.find(x=>x.c===v);
if(p){productSelect.value=products.indexOf(p);addItem();search.value="";}
}

function addItem(){
let p=products[productSelect.value];
let q=+qty.value;
let inCart=cart.find(i=>i.n===p.n);
let used=inCart?inCart.q:0;
if(q+used>p.s)return alert("Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± ÙƒØ§ÙÙŠ");
inCart?inCart.q+=q:cart.push({n:p.n,p:p.p,q});
renderInvoice();
}

function renderInvoice(){
items.innerHTML="";let t=0;
cart.forEach(i=>{
t+=i.p*i.q;
items.innerHTML+=`<div class="item"><span>${i.n} Ã— ${i.q}</span><span>${i.p*i.q}</span></div>`;
});
total.innerText="Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: "+t;
}

function setPay(t){
payType=t;
customerSelect.style.display=t==="credit"?"block":"none";
}

function saveInvoice(){
if(!cart.length)return;
let totalVal=0,profit=0;
let printedCart=[...cart];
if(payType==="credit"){
let c=customers[customerSelect.value];
if(c.locked)return alert("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙˆÙ„");
}
cart.forEach(i=>{
let pr=products.find(p=>p.n===i.n);
totalVal+=i.p*i.q;
profit+=(i.p-(pr.buy||0))*i.q;
pr.s-=i.q;
});
if(payType==="credit"){
customers[customerSelect.value].balance+=totalVal;
}
invoices.push({
no:invoiceNo++,
total:totalVal,
profit,
type:payType,
date:new Date().toLocaleString()
});
cart=[];
save();
renderInvoice();
printInvoice(printedCart,totalVal);
}

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
function printInvoice(items,t){
printArea.innerHTML=`
<div style="font-family:Courier New;text-align:center">
<b>Ø¨Ù‚Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ø¬ Ù…Ø­Ù…ÙˆØ¯</b><br>
ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${invoiceNo-1}<br>
------------------<br>
${items.map(i=>`${i.n}<br>${i.q} Ã— ${i.p} = ${i.q*i.p}`).join("<br>")}
<br>------------------<br>
<b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t}</b>
</div>`;
window.print();
}

/* ===== Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙƒØ§Ù…ÙŠØ±Ø§ ===== */
function scan(){
camera.style.display="block";
new ZXing.BrowserBarcodeReader()
.decodeFromVideoDevice(null,"camera",(r)=>{
if(r){
let p=products.find(x=>x.c===r.text);
if(p){productSelect.value=products.indexOf(p);addItem();}
camera.style.display="none";
}
});
}

/* ===== Ø£ØµÙ†Ø§Ù ===== */
function addProduct(){
products.push({
n:pName.value,
buy:+pBuy.value,
p:+pPrice.value,
s:+pQty.value,
c:pCode.value
});
pName.value=pBuy.value=pPrice.value=pQty.value=pCode.value="";
save();renderAll();
}
function renderProductTable(){
productTable.innerHTML="";
products.forEach(p=>{
productTable.innerHTML+=`<tr><td>${p.n}</td><td>${p.buy}</td><td>${p.p}</td><td>${p.s}</td></tr>`;
});
}

/* ===== Ø¹Ù…Ù„Ø§Ø¡ ===== */
function addCustomer(){
customers.push({n:cName.value,balance:0,locked:false});
cName.value="";save();renderAll();
}
function renderCustomers(){
customerTable.innerHTML="";
customers.forEach((c,i)=>{
customerTable.innerHTML+=`
<tr>
<td>${c.n}</td>
<td>${c.balance}</td>
<td><button onclick="payCustomer(${i})">Ø³Ø¯Ø§Ø¯</button></td>
<td><button onclick="toggleLock(${i})">${c.locked?"Ù…Ù‚ÙÙˆÙ„":"Ù…ÙØªÙˆØ­"}</button></td>
</tr>`;
});
customerSelect.innerHTML="";
customers.forEach((c,i)=>customerSelect.innerHTML+=`<option value="${i}">${c.n}</option>`);
}
function payCustomer(i){
let a=+prompt("Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯");
if(a>0){customers[i].balance-=a;save();renderAll();}
}
function toggleLock(i){
customers[i].locked=!customers[i].locked;
save();renderAll();
}

/* ===== ØªÙ‚Ø§Ø±ÙŠØ± ===== */
function reportDaily(){
let d=new Date().toLocaleDateString();
let r=invoices.filter(i=>i.date.includes(d));
report.innerText="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…: "+r.reduce((a,i)=>a+i.total,0);
}
function reportMonthly(){
let m=new Date().getMonth();
let r=invoices.filter(i=>new Date(i.date).getMonth()===m);
report.innerText="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ù‡Ø±: "+r.reduce((a,i)=>a+i.total,0);
}
function reportYearly(){
let y=new Date().getFullYear();
let r=invoices.filter(i=>new Date(i.date).getFullYear()===y);
report.innerText="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†Ø©: "+r.reduce((a,i)=>a+i.total,0);
}

/* ===== Ø£Ø±Ø¨Ø§Ø­ ===== */
function profitDaily(){
let d=new Date().toLocaleDateString();
profitResult.innerText="Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…: "+
invoices.filter(i=>i.date.includes(d)).reduce((a,i)=>a+(i.profit||0),0);
}
function profitMonthly(){
let m=new Date().getMonth();
profitResult.innerText="Ø±Ø¨Ø­ Ø§Ù„Ø´Ù‡Ø±: "+
invoices.filter(i=>new Date(i.date).getMonth()===m).reduce((a,i)=>a+(i.profit||0),0);
}
function profitYearly(){
let y=new Date().getFullYear();
profitResult.innerText="Ø±Ø¨Ø­ Ø§Ù„Ø³Ù†Ø©: "+
invoices.filter(i=>new Date(i.date).getFullYear()===y).reduce((a,i)=>a+(i.profit||0),0);
}

/* ===== Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ===== */
function backup(){
let data={products,customers,invoices,invoiceNo};
let a=document.createElement("a");
a.href=URL.createObjectURL(new Blob([JSON.stringify(data)]));
a.download="backup.json";
a.click();
}
function restore(input){
let r=new FileReader();
r.onload=()=>{
let d=JSON.parse(r.result);
products=d.products||[];
customers=d.customers||[];
invoices=d.invoices||[];
invoiceNo=d.invoiceNo||1;
save();renderAll();
alert("ØªÙ… Ø§Ù„Ø§Ø³ØªØ±Ø¬Ø§Ø¹");
};
r.readAsText(input.files[0]);
}

/* ===== Ø­ÙØ¸ ===== */
function save(){
localStorage.products=JSON.stringify(products);
localStorage.customers=JSON.stringify(customers);
localStorage.invoices=JSON.stringify(invoices);
localStorage.invoiceNo=invoiceNo;
}
function renderAll(){
renderProducts();
renderProductTable();
renderCustomers();
}
renderAll();
</script>

<script>
if("serviceWorker" in navigator){
navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
