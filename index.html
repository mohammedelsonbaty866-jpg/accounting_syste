<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>POS Ø¨Ù‚Ø§Ù„Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
--main:#1e293b;--accent:#2563eb;--success:#16a34a;
--danger:#dc2626;--bg:#f1f5f9;--card:#fff
}
body{margin:0;font-family:Tahoma;direction:rtl;background:var(--bg)}
header{background:var(--main);color:#fff;padding:14px;text-align:center;font-size:18px}
.container{padding:10px;display:grid;gap:10px}
.card{background:var(--card);border-radius:14px;padding:14px;
box-shadow:0 6px 12px rgba(0,0,0,.08)}
h3{margin:0 0 10px;color:var(--main)}
input,select{width:100%;padding:12px;margin:6px 0;
border-radius:10px;border:1px solid #cbd5f5;font-size:15px}
button{width:100%;padding:14px;border:none;border-radius:12px;
font-size:16px;font-weight:bold;margin-top:6px}
.btn-main{background:var(--accent);color:#fff}
.btn-success{background:var(--success);color:#fff}
.btn-warning{background:#f59e0b;color:#fff}
.invoice-item{display:flex;justify-content:space-between;
padding:6px 0;border-bottom:1px dashed #ddd}
.total{font-size:20px;font-weight:bold;color:var(--success);text-align:center}
.hidden{display:none}
.alert{color:var(--danger);font-weight:bold;text-align:center}
@media print{
body *{visibility:hidden}
#printArea,*#printArea *{visibility:visible}
#printArea{position:absolute;top:0;right:0;width:58mm;font-size:12px}
}
</style>
</head>

<body>
<header>ğŸ›’ Ù†Ø¸Ø§Ù… Ø¨Ù‚Ø§Ù„Ø©</header>

<div class="container">

<div class="card">
<h3>â• Ø¨ÙŠØ¹ Ø³Ø±ÙŠØ¹</h3>
<input id="search" placeholder="Ø¨Ø­Ø« Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯">
<button class="btn-main" onclick="scanBarcode()">ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<select id="productSelect"></select>
<input id="qty" type="number" value="1" min="1">
<button class="btn-success" onclick="addItem()">Ø¥Ø¶Ø§ÙØ©</button>
<div id="stockAlert" class="alert"></div>
</div>

<div class="card">
<h3>ğŸ§¾ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
<div id="items"></div>
<div class="total" id="total">0</div>

<select id="payType" onchange="payChange()">
<option value="cash">ğŸ’µ Ù†Ù‚Ø¯ÙŠ</option>
<option value="credit">ğŸ•’ Ø¢Ø¬Ù„</option>
</select>

<select id="customer" class="hidden"></select>
<button id="saveBtn" class="btn-main" onclick="saveInvoice()">Ø­ÙØ¸ + Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<div class="card">
<h3>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ±</h3>
<button class="btn-main" onclick="dailyReport()">ğŸ“… ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
<button class="btn-main" onclick="monthlyReport()">ğŸ—“ï¸ ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</button>
<div id="report"></div>
</div>

</div>

<div id="printArea"></div>

<script>
/* ===== ØªØ­Ù…ÙŠÙ„ Ø¢Ù…Ù† ===== */
function safeLoad(k,def){
 try{ return JSON.parse(localStorage.getItem(k))||def }catch{ return def }
}
let products=safeLoad("products",[
 {n:"Ø³ÙƒØ±",p:15,s:10,c:"111"},
 {n:"Ø²ÙŠØª",p:70,s:20,c:"222"}
]);
let customers=safeLoad("customers",[]);
let invoices=safeLoad("invoices",[]);
let cart=[];

/* ===== Ø¨Ø­Ø« ===== */
search.oninput=()=>renderProducts(search.value.trim());
function renderProducts(v){
productSelect.innerHTML="";
products.forEach((p,i)=>{
if(p.c.trim()===v||p.n.toLowerCase().includes(v.toLowerCase()))
productSelect.innerHTML+=`<option value="${i}">${p.n} (${p.s})</option>`;
});
}

/* ===== Ø¨Ø§Ø±ÙƒÙˆØ¯ ===== */
async function scanBarcode(){
if(!('BarcodeDetector'in window))return alert("ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…");
let detector=new BarcodeDetector();
let stream=await navigator.mediaDevices.getUserMedia({video:true});
let video=document.createElement("video");
video.srcObject=stream;video.play();
setTimeout(async()=>{
let b=await detector.detect(video);
if(b.length){search.value=b[0].rawValue.trim();renderProducts(search.value)}
stream.getTracks().forEach(t=>t.stop());
},3000);
}

/* ===== Ø¥Ø¶Ø§ÙØ© ===== */
function addItem(){
let i=productSelect.value,q=+qty.value;
if(i===""||q<=0)return;
let p=products[i];
if(q>p.s)return alert("Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§ ÙŠÙƒÙÙŠ");
cart.push({n:p.n,p:p.p,q});
render();
}

/* ===== Ø¹Ø±Ø¶ ===== */
function render(){
let t=0;items.innerHTML="";
cart.forEach(i=>{
t+=i.p*i.q;
items.innerHTML+=`<div class="invoice-item"><span>${i.n} Ã— ${i.q}</span><span>${i.p*i.q}</span></div>`;
});
total.innerText=t;
checkStock();
}

/* ===== Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹ ===== */
function payChange(){
customer.classList.toggle("hidden",payType.value!=="credit");
loadCustomers();
}

/* ===== Ø­ÙØ¸ ===== */
function saveInvoice(){
if(!cart.length)return;
saveBtn.disabled=true;

let t=cart.reduce((a,i)=>a+i.p*i.q,0);
let no=invoices.length+1;
let iso=new Date().toISOString();
let itemsCopy=[...cart];

if(payType.value==="credit"){
let c=customers[customer.value];
if(!c||c.locked){saveBtn.disabled=false;return alert("Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙˆÙ„");}
c.balance+=t;
c.ops.push({date:iso,type:"Ø¨ÙŠØ¹",total:t,inv:no});
}

itemsCopy.forEach(i=>products.find(p=>p.n===i.n).s-=i.q);

invoices.push({no,date:iso,total:t,type:payType.value,items:itemsCopy});

localStorage.setItem("products",JSON.stringify(products));
localStorage.setItem("customers",JSON.stringify(customers));
localStorage.setItem("invoices",JSON.stringify(invoices));

printInvoice(no,iso,t,itemsCopy);
cart=[];render();saveBtn.disabled=false;
}

/* ===== Ø·Ø¨Ø§Ø¹Ø© ===== */
function printInvoice(no,date,t,items){
printArea.innerHTML=
`<b>ÙØ§ØªÙˆØ±Ø© Ø±Ù‚Ù… ${no}</b><br>
${items.map(i=>`${i.n} Ã— ${i.q} = ${i.p*i.q}`).join("<br>")}
<hr>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${t}<br>${new Date(date).toLocaleString()}`;
window.print();
}

/* ===== ØªÙ‚Ø§Ø±ÙŠØ± ===== */
function dailyReport(){
let d=new Date().toISOString().split("T")[0];
let r=invoices.filter(i=>i.date.startsWith(d));
let cash=r.filter(i=>i.type==="cash").reduce((a,i)=>a+i.total,0);
let credit=r.filter(i=>i.type==="credit").reduce((a,i)=>a+i.total,0);
report.innerHTML=`Ø§Ù„ÙŠÙˆÙ…<br>Ù†Ù‚Ø¯ÙŠ: ${cash}<br>Ø¢Ø¬Ù„: ${credit}`;
}
function monthlyReport(){
let m=new Date().getMonth(),y=new Date().getFullYear();
let r=invoices.filter(i=>{let d=new Date(i.date);return d.getMonth()===m&&d.getFullYear()===y});
report.innerHTML=`Ø§Ù„Ø´Ù‡Ø±: ${r.reduce((a,i)=>a+i.total,0)}`;
}

/* ===== Ù…Ø®Ø²ÙˆÙ† ===== */
function checkStock(){
stockAlert.innerHTML="";
products.forEach(p=>{if(p.s<=5)stockAlert.innerHTML+=`âš ï¸ ${p.n}<br>`});
}
function loadCustomers(){
customer.innerHTML="";
customers.forEach((c,i)=>customer.innerHTML+=`<option value="${i}">${c.n}</option>`);
}
</script>
</body>
</html>
